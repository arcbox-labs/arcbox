name: E2E Tests

on:
  push:
    branches: [master, develop]
    paths:
      - 'crates/**'
      - 'guest/**'
      - 'tests/e2e/**'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [master, develop]
    paths:
      - 'crates/**'
      - 'guest/**'
      - 'tests/e2e/**'
  workflow_dispatch:
    inputs:
      run_vm_tests:
        description: 'Run VM-based E2E tests (requires virtualization)'
        required: false
        default: 'false'
        type: boolean
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==========================================================================
  # Unit Tests (no VM required)
  # ==========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Protobuf compiler
        timeout-minutes: 5
        run: |
          brew install protobuf

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run unit tests
        timeout-minutes: 20
        run: |
          cargo test --workspace --exclude arcbox-e2e -- --skip ignored

      - name: Run arcbox-image auto-pull tests
        timeout-minutes: 5
        run: |
          cargo test -p arcbox-image -- test_get_manifest_not_found test_get_image_config_not_found test_image_not_found

  # ==========================================================================
  # Build (prepare artifacts for E2E tests)
  #
  # MLT-041: musl toolchain cached separately, step-level timeouts,
  #          build steps split for better failure diagnostics.
  # ==========================================================================
  build:
    name: Build
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-unknown-linux-musl

      - name: Install Protobuf compiler
        timeout-minutes: 5
        run: |
          brew install protobuf

      - name: Install initramfs build tools
        timeout-minutes: 5
        run: |
          brew install squashfs

      # MLT-041: Cache musl-cross toolchain to avoid repeated Homebrew builds.
      # The musl-cross formula compiles from source and is the slowest step.
      - name: Cache musl-cross toolchain
        id: cache-musl
        uses: actions/cache@v4
        with:
          path: |
            /opt/homebrew/Cellar/musl-cross
            /opt/homebrew/bin/aarch64-linux-musl-*
            /opt/homebrew/opt/musl-cross
          key: ${{ runner.os }}-musl-cross-v1

      - name: Install musl cross-compiler
        timeout-minutes: 30
        run: |
          if ! command -v aarch64-linux-musl-gcc >/dev/null 2>&1; then
            echo "::group::Installing musl-cross from source (this takes a while)"
            brew install FiloSottile/musl-cross/musl-cross
            echo "::endgroup::"
          else
            echo "musl-cross already available (from cache)"
          fi

          mkdir -p "$HOME/.local/bin"
          if command -v aarch64-unknown-linux-musl-gcc >/dev/null 2>&1; then
            echo "Found linker: $(command -v aarch64-unknown-linux-musl-gcc)"
          elif command -v aarch64-linux-musl-gcc >/dev/null 2>&1; then
            ln -sf "$(command -v aarch64-linux-musl-gcc)" \
              "$HOME/.local/bin/aarch64-unknown-linux-musl-gcc"
            echo "$HOME/.local/bin" >> "$GITHUB_PATH"
            echo "Created linker shim: $HOME/.local/bin/aarch64-unknown-linux-musl-gcc"
          else
            echo "::error::Missing musl linker binary after install"
            ls -1 /opt/homebrew/bin/*musl*gcc 2>/dev/null || echo "No musl-gcc binaries found"
            exit 1
          fi

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-
            ${{ runner.os }}-cargo-

      - name: Build arcbox (release)
        timeout-minutes: 15
        run: |
          cargo build --release -p arcbox-cli

      # MLT-041: Separate step for cross-compilation with its own timeout.
      - name: Build arcbox-agent (cross-compile for Linux)
        timeout-minutes: 15
        run: |
          cargo build --release -p arcbox-agent --target aarch64-unknown-linux-musl

      - name: Sign binary with virtualization entitlement
        run: |
          codesign --entitlements tests/resources/entitlements.plist \
            --force -s - target/release/arcbox

      - name: Download kernel
        timeout-minutes: 5
        run: |
          cd tests/resources
          ./download-kernel.sh
          if [ ! -f Image-arm64 ] && [ -f vmlinuz-arm64 ]; then
            cp vmlinuz-arm64 Image-arm64
          fi

      - name: Checkout boot-assets
        uses: actions/checkout@v4
        with:
          repository: arcbox-labs/boot-assets
          path: boot-assets
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build initramfs
        timeout-minutes: 5
        env:
          BOOT_ASSETS_DIR: ${{ github.workspace }}/boot-assets
        run: |
          cd tests/resources
          ./build-initramfs.sh

      - name: Verify artifacts
        run: |
          echo "=== Build artifacts ==="
          ls -lh target/release/arcbox
          ls -lh target/aarch64-unknown-linux-musl/release/arcbox-agent
          ls -lh tests/resources/Image-arm64
          ls -lh tests/resources/initramfs-arcbox

      - name: Upload arcbox binary
        uses: actions/upload-artifact@v4
        with:
          name: arcbox-macos-arm64
          path: target/release/arcbox
          retention-days: 7

      - name: Upload arcbox-agent binary
        uses: actions/upload-artifact@v4
        with:
          name: arcbox-agent-linux-arm64
          path: target/aarch64-unknown-linux-musl/release/arcbox-agent
          retention-days: 7

      - name: Upload boot assets
        uses: actions/upload-artifact@v4
        with:
          name: boot-assets
          path: |
            tests/resources/Image-arm64
            tests/resources/initramfs-arcbox
          retention-days: 7

      # MLT-041: Step summary for build timing visibility.
      - name: Build summary
        if: always()
        run: |
          echo "### Build Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          for f in target/release/arcbox target/aarch64-unknown-linux-musl/release/arcbox-agent tests/resources/Image-arm64 tests/resources/initramfs-arcbox; do
            if [ -f "$f" ]; then
              SIZE=$(ls -lh "$f" | awk '{print $5}')
              echo "| \`$(basename $f)\` | OK ($SIZE) |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| \`$(basename $f)\` | **MISSING** |" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

  # ==========================================================================
  # E2E VM Tests with Matrix (MLT-040)
  #
  # Runs smoke tests for each backend x distro combination.
  # ==========================================================================
  e2e-vm-tests:
    name: E2E VM Tests
    needs: build
    runs-on: macos-14
    timeout-minutes: 60
    if: |
      github.ref == 'refs/heads/master' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_vm_tests == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Protobuf compiler
        timeout-minutes: 5
        run: |
          brew install protobuf

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Download arcbox binary
        uses: actions/download-artifact@v4
        with:
          name: arcbox-macos-arm64
          path: target/release/

      - name: Download boot assets
        uses: actions/download-artifact@v4
        with:
          name: boot-assets
          path: tests/resources/

      - name: Make binary executable and sign
        run: |
          chmod +x target/release/arcbox
          codesign --entitlements tests/resources/entitlements.plist \
            --force -s - target/release/arcbox

      - name: Verify virtualization capability
        id: check-virt
        continue-on-error: true
        run: |
          if system_profiler SPSoftwareDataType | grep -q "System Integrity Protection: enabled"; then
            echo "SIP is enabled"
          fi
          echo "virt_available=true" >> $GITHUB_OUTPUT

      # MLT-040: Smoke matrix tests (backend x distro).
      - name: Run smoke matrix tests (native_control_plane x alpine)
        id: smoke_native_alpine
        if: steps.check-virt.outputs.virt_available == 'true'
        continue-on-error: true
        timeout-minutes: 10
        env:
          ARCBOX_TEST_BACKEND: native-control-plane
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'warn' }}
        run: |
          cargo test -p arcbox-e2e --test smoke_matrix -- --ignored test_smoke_native_alpine test_lifecycle_native_alpine --nocapture 2>&1 | tee /tmp/e2e-smoke-native-alpine.log
      - name: Run smoke matrix tests (native_control_plane x ubuntu)
        id: smoke_native_ubuntu
        if: steps.check-virt.outputs.virt_available == 'true'
        continue-on-error: true
        timeout-minutes: 10
        env:
          ARCBOX_TEST_BACKEND: native-control-plane
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'warn' }}
        run: |
          cargo test -p arcbox-e2e --test smoke_matrix -- --ignored test_smoke_native_ubuntu test_lifecycle_native_ubuntu --nocapture 2>&1 | tee /tmp/e2e-smoke-native-ubuntu.log
      - name: Run smoke matrix tests (guest_docker x alpine)
        id: smoke_guest_alpine
        if: steps.check-virt.outputs.virt_available == 'true'
        continue-on-error: true
        timeout-minutes: 10
        env:
          ARCBOX_TEST_BACKEND: guest-docker
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'warn' }}
        run: |
          cargo test -p arcbox-e2e --test smoke_matrix -- --ignored test_smoke_guest_docker_alpine test_lifecycle_guest_docker_alpine --nocapture 2>&1 | tee /tmp/e2e-smoke-guest-docker-alpine.log
      - name: Run smoke matrix tests (guest_docker x ubuntu)
        id: smoke_guest_ubuntu
        if: steps.check-virt.outputs.virt_available == 'true'
        continue-on-error: true
        timeout-minutes: 10
        env:
          ARCBOX_TEST_BACKEND: guest-docker
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'warn' }}
        run: |
          cargo test -p arcbox-e2e --test smoke_matrix -- --ignored test_smoke_guest_docker_ubuntu test_lifecycle_guest_docker_ubuntu --nocapture 2>&1 | tee /tmp/e2e-smoke-guest-docker-ubuntu.log
      # Existing E2E suites (run on default backend).
      - name: Run E2E tests (VM lifecycle)
        if: steps.check-virt.outputs.virt_available == 'true'
        continue-on-error: true
        timeout-minutes: 10
        env:
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'warn' }}
        run: |
          cargo test -p arcbox-e2e -- --ignored test_vm --nocapture 2>&1 | tee /tmp/e2e-vm.log
      - name: Run E2E tests (container lifecycle)
        if: steps.check-virt.outputs.virt_available == 'true'
        continue-on-error: true
        timeout-minutes: 15
        env:
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'warn' }}
        run: |
          cargo test -p arcbox-e2e -- --ignored test_container --nocapture 2>&1 | tee /tmp/e2e-container.log
      - name: Run E2E tests (image operations)
        if: steps.check-virt.outputs.virt_available == 'true'
        continue-on-error: true
        timeout-minutes: 10
        env:
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'warn' }}
        run: |
          cargo test -p arcbox-e2e -- --ignored test_image --nocapture 2>&1 | tee /tmp/e2e-image.log
      # MLT-041: Structured test summary for quick failure diagnosis.
      - name: Summarize test results
        if: always()
        run: |
          echo "### E2E Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Suite | Passed | Failed |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|--------|" >> "$GITHUB_STEP_SUMMARY"

          for log in /tmp/e2e-*.log; do
            if [ -f "$log" ]; then
              SUITE=$(basename "$log" .log | sed 's/^e2e-//')
              PASSED=$(grep -c " \.\.\. ok$" "$log" 2>/dev/null || echo "0")
              FAILED=$(grep -c " \.\.\. FAILED$" "$log" 2>/dev/null || echo "0")
              if [ "$FAILED" -gt 0 ]; then
                echo "| $SUITE | $PASSED | **$FAILED** |" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "| $SUITE | $PASSED | $FAILED |" >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Print failed tests to summary.
          HAS_FAILURES=false
          for log in /tmp/e2e-*.log; do
            if [ -f "$log" ] && grep -q "FAILED" "$log"; then
              HAS_FAILURES=true
              echo "#### Failed tests in $(basename "$log")" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              grep "FAILED" "$log" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            fi
          done

          if [ "$HAS_FAILURES" = false ]; then
            echo "> All executed tests passed." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Enforce smoke matrix on master
        if: always() && github.ref == 'refs/heads/master' && steps.check-virt.outputs.virt_available == 'true'
        run: |
          FAILED=0

          if [ "${{ steps.smoke_native_alpine.outcome }}" != "success" ]; then
            echo "::error::native_control_plane x alpine failed"
            FAILED=1
          fi

          if [ "${{ steps.smoke_native_ubuntu.outcome }}" != "success" ]; then
            echo "::error::native_control_plane x ubuntu failed"
            FAILED=1
          fi

          if [ "${{ steps.smoke_guest_alpine.outcome }}" != "success" ]; then
            echo "::error::guest_docker x alpine failed"
            FAILED=1
          fi

          if [ "${{ steps.smoke_guest_ubuntu.outcome }}" != "success" ]; then
            echo "::error::guest_docker x ubuntu failed"
            FAILED=1
          fi

          if [ "$FAILED" -ne 0 ]; then
            exit 1
          fi

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs
          path: /tmp/e2e-*.log
          retention-days: 7
          if-no-files-found: ignore

  # ==========================================================================
  # E2E Tests (Self-hosted runner with VM support)
  # ==========================================================================
  e2e-self-hosted:
    name: E2E Tests (Self-Hosted)
    needs: build
    runs-on: [self-hosted, macOS, ARM64, virtualization]
    timeout-minutes: 60
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.run_vm_tests == 'true'
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Protobuf compiler
        timeout-minutes: 5
        run: |
          brew install protobuf

      - name: Download arcbox binary
        uses: actions/download-artifact@v4
        with:
          name: arcbox-macos-arm64
          path: target/release/

      - name: Download boot assets
        uses: actions/download-artifact@v4
        with:
          name: boot-assets
          path: tests/resources/

      - name: Make binary executable and sign
        run: |
          chmod +x target/release/arcbox
          codesign --entitlements tests/resources/entitlements.plist \
            --force -s - target/release/arcbox

      # MLT-040: Run smoke matrix first, then full suite.
      - name: Run smoke matrix (all combinations)
        timeout-minutes: 20
        env:
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'info' }}
        run: |
          cargo build -p arcbox-e2e --tests
          cargo test -p arcbox-e2e --test smoke_matrix -- --ignored --nocapture 2>&1 | tee /tmp/e2e-smoke-matrix.log

      - name: Run full E2E test suite
        timeout-minutes: 30
        env:
          E2E_VERBOSE: ${{ github.event.inputs.verbose == 'true' && '1' || '' }}
          RUST_LOG: ${{ github.event.inputs.verbose == 'true' && 'debug' || 'info' }}
        run: |
          cargo test -p arcbox-e2e -- --ignored --nocapture 2>&1 | tee /tmp/e2e-full.log

      - name: Parse test results
        if: always()
        run: |
          echo "### Self-Hosted E2E Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          for log in /tmp/e2e-smoke-matrix.log /tmp/e2e-full.log; do
            if [ -f "$log" ]; then
              SUITE=$(basename "$log" .log)
              PASSED=$(grep -c " \.\.\. ok$" "$log" 2>/dev/null || echo "0")
              FAILED=$(grep -c " \.\.\. FAILED$" "$log" 2>/dev/null || echo "0")
              IGNORED=$(grep -c " \.\.\. ignored$" "$log" 2>/dev/null || echo "0")

              echo "**$SUITE**: $PASSED passed, $FAILED failed, $IGNORED ignored" >> "$GITHUB_STEP_SUMMARY"

              if [ "$FAILED" -gt 0 ]; then
                echo '```' >> "$GITHUB_STEP_SUMMARY"
                grep "FAILED" "$log" >> "$GITHUB_STEP_SUMMARY"
                echo '```' >> "$GITHUB_STEP_SUMMARY"
                exit 1
              fi
            fi
          done

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-self-hosted-logs
          path: /tmp/e2e-*.log
          retention-days: 14

  # ==========================================================================
  # Summary Job
  # ==========================================================================
  summary:
    name: Test Summary
    needs: [unit-tests, build, e2e-vm-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check results
        run: |
          echo "=== CI Summary ==="
          echo ""
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Build:      ${{ needs.build.result }}"
          echo "E2E Tests:  ${{ needs.e2e-vm-tests.result }}"
          echo ""

          # Fail if critical jobs failed
          if [ "${{ needs.unit-tests.result }}" == "failure" ]; then
            echo "Unit tests failed"
            exit 1
          fi

          if [ "${{ needs.build.result }}" == "failure" ]; then
            echo "Build failed"
            exit 1
          fi

          # E2E tests gate the pipeline when they ran.
          if [ "${{ needs.e2e-vm-tests.result }}" == "failure" ]; then
            echo "::error::E2E tests failed"
            exit 1
          fi

          echo "CI passed"
